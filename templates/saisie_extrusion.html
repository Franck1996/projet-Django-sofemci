{% extends 'base.html' %}
{% load static %}

{% block title %}Saisie Production Extrusion - SOFEM-CI{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Messages d'erreur/succ√®s -->
    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-triangle{% endif %} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Affichage des erreurs du formulaire -->
    {% if form.errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        <strong>Erreurs de validation :</strong>
        <ul class="mb-0 mt-2">
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                <li><strong>{{ field|capfirst }} :</strong> {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- En-t√™te avec informations contextuelles -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-2">üè≠ Saisie Production - Extrusion</h1>
            <div class="d-flex align-items-center gap-3">
                <span class="badge bg-primary fs-6">
                    <i class="fas fa-calendar me-1"></i>{{ today|date:"d/m/Y" }}
                </span>
                <span class="text-muted">Saisie des donn√©es de production pour les zones d'extrusion</span>
            </div>
        </div>
        <div class="text-end">
            <div class="user-info">
                <span class="badge bg-secondary fs-6">
                    <i class="fas fa-user me-1"></i>{{ user.get_full_name|default:user.username }}
                </span>
            </div>
        </div>
    </div>

    <form method="post" class="production-form" id="extrusion-form" novalidate>
        {% csrf_token %}
        
        <div class="row">
            <!-- Colonne principale -->
            <div class="col-lg-12">
                <!-- Informations de base -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>Informations G√©n√©rales
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.date_production.id_for_label }}" class="form-label required">Date de production</label>
                                    {{ form.date_production }}
                                    {% if form.date_production.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.date_production.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.zone.id_for_label }}" class="form-label required">Zone d'extrusion</label>
                                    {{ form.zone }}
                                    {% if form.zone.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.zone.errors.0 }}
                                    </div>
                                    {% endif %}
                                    <div class="form-text" id="zone-info">
                                        Capacit√©: <span id="zone-capacity">--</span> kg/h
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.equipe.id_for_label }}" class="form-label required">√âquipe</label>
                                    {{ form.equipe }}
                                    {% if form.equipe.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.equipe.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.heure_debut.id_for_label }}" class="form-label required">Heure de d√©but</label>
                                    {{ form.heure_debut }}
                                    {% if form.heure_debut.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.heure_debut.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.heure_fin.id_for_label }}" class="form-label required">Heure de fin</label>
                                    {{ form.heure_fin }}
                                    {% if form.heure_fin.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.heure_fin.errors.0 }}
                                    </div>
                                    {% endif %}
                                    <div class="form-text" id="duration-display">
                                        Dur√©e: <span id="calculated-duration">--:--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.chef_zone.id_for_label }}" class="form-label required">Chef de zone</label>
                                    {{ form.chef_zone }}
                                    {% if form.chef_zone.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.chef_zone.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ressources utilis√©es -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-tools me-2"></i>Ressources Utilis√©es
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.matiere_premiere_kg.id_for_label }}" class="form-label required">
                                        Mati√®re premi√®re
                                    </label>
                                    <div class="input-group">
                                        {{ form.matiere_premiere_kg }}
                                        <span class="input-group-text">kg</span>
                                    </div>
                                    {% if form.matiere_premiere_kg.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.matiere_premiere_kg.errors.0 }}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Quantit√© totale consomm√©e
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.nombre_machines_actives.id_for_label }}" class="form-label required">
                                        Machines actives
                                    </label>
                                    <div class="input-group">
                                        {{ form.nombre_machines_actives }}
                                        <span class="input-group-text">unit√©s</span>
                                    </div>
                                    {% if form.nombre_machines_actives.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.nombre_machines_actives.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.nombre_machinistes.id_for_label }}" class="form-label required">
                                        Nombre de machinistes
                                    </label>
                                    <div class="input-group">
                                        {{ form.nombre_machinistes }}
                                        <span class="input-group-text">personnes</span>
                                    </div>
                                    {% if form.nombre_machinistes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.nombre_machinistes.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Production -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>Production
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.nombre_bobines_kg.id_for_label }}" class="form-label required">
                                        Bobines produites
                                    </label>
                                    <div class="input-group">
                                        {{ form.nombre_bobines_kg }}
                                        <span class="input-group-text">kg</span>
                                    </div>
                                    {% if form.nombre_bobines_kg.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.nombre_bobines_kg.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.production_finis_kg.id_for_label }}" class="form-label required">
                                        Produits finis
                                    </label>
                                    <div class="input-group">
                                        {{ form.production_finis_kg }}
                                        <span class="input-group-text">kg</span>
                                    </div>
                                    {% if form.production_finis_kg.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.production_finis_kg.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.production_semi_finis_kg.id_for_label }}" class="form-label required">
                                        Produits semi-finis
                                    </label>
                                    <div class="input-group">
                                        {{ form.production_semi_finis_kg }}
                                        <span class="input-group-text">kg</span>
                                    </div>
                                    {% if form.production_semi_finis_kg.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.production_semi_finis_kg.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.dechets.id_for_label }}" class="form-label required">
                                        D√©chets g√©n√©r√©s
                                    </label>
                                    <div class="input-group">
                                        {{ form.dechets }}
                                        <span class="input-group-text">kg</span>
                                    </div>
                                    {% if form.dechets.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.dechets.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observations -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-clipboard-list me-2"></i>Observations
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.observations.id_for_label }}" class="form-label">
                                Remarques et observations du jour
                            </label>
                            {{ form.observations }}
                            <div class="form-text">
                                <i class="fas fa-lightbulb me-1"></i>
                                D√©crivez les √©v√©nements marquants de la journ√©e de production
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Validation et actions -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg" id="submit-btn">
                                <i class="fas fa-save me-2"></i>Enregistrer la production
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_css %}
<style>
.required::after {
    content: " *";
    color: #dc3545;
}

.card-header {
    font-weight: 600;
}

.form-control-lg {
    border-radius: 0.5rem;
}

.input-group-text {
    background-color: #f8f9fa;
    border: 1px solid #ced4da;
    font-weight: 500;
}

.badge {
    font-size: 0.75em;
}

.form-control.is-invalid {
    border-color: #dc3545;
}

.invalid-feedback {
    display: block;
    color: #dc3545;
    font-size: 0.875em;
    margin-top: 0.25rem;
}

@media (max-width: 768px) {
    .container-fluid {
        padding-left: 15px;
        padding-right: 15px;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .btn-lg {
        width: 100%;
        margin-top: 0.5rem;
    }
}

#submit-btn:disabled {
    opacity: 0.65;
    cursor: not-allowed;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Fonction principale de calcul
function calculerAutomatique() {
    console.log('Calcul automatique d√©clench√©');
    
    // R√©cup√©ration des valeurs avec v√©rification - UTILISER LE BON ID
    const finis = parseFloat(document.getElementById('{{ form.production_finis_kg.id_for_label }}').value) || 0;
    const semiFinis = parseFloat(document.getElementById('{{ form.production_semi_finis_kg.id_for_label }}').value) || 0;
    const matiere = parseFloat(document.getElementById('{{ form.matiere_premiere_kg.id_for_label }}').value) || 0;
    const dechets = parseFloat(document.getElementById('{{ form.dechets.id_for_label }}').value) || 0;
    const machines = parseInt(document.getElementById('{{ form.nombre_machines_actives.id_for_label }}').value) || 0;
    
    // Calcul de la dur√©e
    const heureDebut = document.getElementById('{{ form.heure_debut.id_for_label }}').value;
    const heureFin = document.getElementById('{{ form.heure_fin.id_for_label }}').value;
    let dureeHeures = 0;
    
    if (heureDebut && heureFin) {
        const debut = new Date('2000-01-01T' + heureDebut + ':00');
        const fin = new Date('2000-01-01T' + heureFin + ':00');
        
        // Gestion du passage √† minuit
        if (fin < debut) {
            fin.setHours(fin.getHours() + 24);
        }
        
        const diff = fin - debut;
        dureeHeures = diff / (1000 * 60 * 60);
        dureeHeures = dureeHeures > 0 ? dureeHeures : 0;
    }
    
    // Mise √† jour de la dur√©e affich√©e
    if (dureeHeures > 0) {
        const heures = Math.floor(dureeHeures);
        const minutes = Math.round((dureeHeures - heures) * 60);
        document.getElementById('calculated-duration').textContent = 
            `${heures}h${minutes.toString().padStart(2, '0')}`;
    }
}

// Fonction de validation compl√®te
function validerFormExtrusion() {
    const finis = parseFloat(document.getElementById('{{ form.production_finis_kg.id_for_label }}').value) || 0;
    const semiFinis = parseFloat(document.getElementById('{{ form.production_semi_finis_kg.id_for_label }}').value) || 0;
    const matiere = parseFloat(document.getElementById('{{ form.matiere_premiere_kg.id_for_label }}').value) || 0;
    const dechets = parseFloat(document.getElementById('{{ form.dechets.id_for_label }}').value) || 0;
    const heureDebut = document.getElementById('{{ form.heure_debut.id_for_label }}').value;
    const heureFin = document.getElementById('{{ form.heure_fin.id_for_label }}').value;
    const machines = parseInt(document.getElementById('{{ form.nombre_machines_actives.id_for_label }}').value) || 0;
    const machinistes = parseInt(document.getElementById('{{ form.nombre_machinistes.id_for_label }}').value) || 0;
    
    let erreurs = [];
    let duree = '--:--';
    
    // 1. Validation rendement ‚â§ 100%
    if (matiere > 0) {
        const totalProduction = finis + semiFinis;
        if (totalProduction > matiere) {
            erreurs.push(`Production totale (${totalProduction.toFixed(2)} kg) > Mati√®re premi√®re (${matiere.toFixed(2)} kg)`);
        }
    }
    
    // 2. Validation d√©chets
    if (matiere > 0 && dechets > matiere) {
        erreurs.push(`D√©chets (${dechets.toFixed(2)} kg) > Mati√®re premi√®re (${matiere.toFixed(2)} kg)`);
    }
    
    // 3. Validation des heures
    if (heureDebut && heureFin) {
        const debut = new Date('2000-01-01T' + heureDebut + ':00');
        let fin = new Date('2000-01-01T' + heureFin + ':00');
        
        // Gestion travail de nuit
        if (fin < debut) {
            fin.setHours(fin.getHours() + 24);
        }
        
        const dureeHeures = (fin - debut) / (1000 * 60 * 60);
        
        if (dureeHeures <= 0) {
            erreurs.push('Heure de fin doit √™tre apr√®s heure de d√©but');
        } else {
            const heures = Math.floor(dureeHeures);
            const minutes = Math.round((dureeHeures - heures) * 60);
            duree = `${heures}h${minutes.toString().padStart(2, '0')}`;
            
            if (dureeHeures > 12) {
                erreurs.push(`Dur√©e de travail trop longue: ${duree} (max 12h)`);
            }
            
            if (dureeHeures < 1) {
                erreurs.push(`Dur√©e de travail trop courte: ${duree} (min 1h)`);
            }
        }
    }
    
    // Calcul des indicateurs pour le retour
    const total = finis + semiFinis;
    const rendement = matiere > 0 ? (total / matiere) * 100 : 0;
    const tauxDechets = (total + dechets) > 0 ? (dechets / (total + dechets)) * 100 : 0;
    
    return {
        valid: erreurs.length === 0,
        erreurs: erreurs,
        total: total,
        rendement: rendement,
        tauxDechets: tauxDechets,
        duree: duree
    };
}

// Gestion des √©v√©nements
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM charg√©, initialisation des √©v√©nements');
    
    const extrusionForm = document.getElementById('extrusion-form');
    if (extrusionForm) {
        // Validation au submit
        extrusionForm.addEventListener('submit', function(e) {
            const validation = validerFormExtrusion();
            if (!validation.valid) {
                e.preventDefault();
                alert('ERREURS DE VALIDATION:\n\n‚Ä¢ ' + validation.erreurs.join('\n‚Ä¢ '));
            }
        });
        
        // Calcul automatique lors de la saisie - UTILISER LES BONS IDs
        const extrusionInputs = [
            '{{ form.production_finis_kg.id_for_label }}',
            '{{ form.production_semi_finis_kg.id_for_label }}',
            '{{ form.matiere_premiere_kg.id_for_label }}',
            '{{ form.dechets.id_for_label }}',
            '{{ form.nombre_machines_actives.id_for_label }}',
            '{{ form.heure_debut.id_for_label }}',
            '{{ form.heure_fin.id_for_label }}',
            '{{ form.nombre_machinistes.id_for_label }}'
        ];
        
        extrusionInputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', function() {
                    calculerAutomatique();
                    this.classList.add('modified');
                });
            } else {
                console.warn('√âl√©ment non trouv√©:', id);
            }
        });
        
        // Initialisation - premier calcul
        setTimeout(calculerAutomatique, 100);
    }
    
    // Gestion des champs num√©riques - emp√™cher les valeurs n√©gatives
    const numberInputs = document.querySelectorAll('input[type="number"]');
    numberInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.value < 0) {
                this.value = 0;
                calculerAutomatique();
            }
        });
    });
});
</script>
{% endblock %}