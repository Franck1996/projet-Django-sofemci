{% extends 'base.html' %}
{% load static %}

{% block title %}Saisie Production Extrusion - SOFEM-CI{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Messages d'erreur/succ√®s -->
    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-triangle{% endif %} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Affichage des erreurs du formulaire -->
    {% if form.errors %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        <strong>Erreurs de validation :</strong>
        <ul class="mb-0 mt-2">
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                <li><strong>{{ field|capfirst }} :</strong> {{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- En-t√™te avec informations contextuelles -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-2">üè≠ Saisie Production - Extrusion</h1>
            <div class="d-flex align-items-center gap-3">
                <span class="badge bg-primary fs-6">
                    <i class="fas fa-calendar me-1"></i>{{ today|date:"d/m/Y" }}
                </span>
                <span class="text-muted">Saisie des donn√©es de production pour les zones d'extrusion</span>
            </div>
        </div>
        <div class="text-end">
            <div class="user-info">
                <span class="badge bg-secondary fs-6">
                    <i class="fas fa-user me-1"></i>{{ user.get_full_name|default:user.username }}
                </span>
            </div>
        </div>
    </div>

    <form method="post" class="production-form" id="extrusion-form" novalidate>
        {% csrf_token %}
        
        <div class="row">
            <!-- Colonne principale -->
            <div class="col-lg-8">
                <!-- Informations de base -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>Informations G√©n√©rales
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.date_production.id_for_label }}" class="form-label required">Date de production</label>
                                    {{ form.date_production }}
                                    {% if form.date_production.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.date_production.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.zone.id_for_label }}" class="form-label required">Zone d'extrusion</label>
                                    {{ form.zone }}
                                    {% if form.zone.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.zone.errors.0 }}
                                    </div>
                                    {% endif %}
                                    <div class="form-text" id="zone-info">
                                        Capacit√©: <span id="zone-capacity">--</span> kg/h
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.equipe.id_for_label }}" class="form-label required">√âquipe</label>
                                    {{ form.equipe }}
                                    {% if form.equipe.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.equipe.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.heure_debut.id_for_label }}" class="form-label required">Heure de d√©but</label>
                                    {{ form.heure_debut }}
                                    {% if form.heure_debut.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.heure_debut.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.heure_fin.id_for_label }}" class="form-label required">Heure de fin</label>
                                    {{ form.heure_fin }}
                                    {% if form.heure_fin.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.heure_fin.errors.0 }}
                                    </div>
                                    {% endif %}
                                    <div class="form-text" id="duration-display">
                                        Dur√©e: <span id="calculated-duration">--:--</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.chef_zone.id_for_label }}" class="form-label required">Chef de zone</label>
                                    {{ form.chef_zone }}
                                    {% if form.chef_zone.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.chef_zone.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ressources utilis√©es -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-tools me-2"></i>Ressources Utilis√©es
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.matiere_premiere_kg.id_for_label }}" class="form-label required">
                                        Mati√®re premi√®re
                                    </label>
                                    <div class="input-group">
                                        {{ form.matiere_premiere_kg }}
                                        <span class="input-group-text">kg</span>
                                    </div>
                                    {% if form.matiere_premiere_kg.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.matiere_premiere_kg.errors.0 }}
                                    </div>
                                    {% endif %}
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Quantit√© totale consomm√©e
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.nombre_machines_actives.id_for_label }}" class="form-label required">
                                        Machines actives
                                    </label>
                                    <div class="input-group">
                                        {{ form.nombre_machines_actives }}
                                        <span class="input-group-text">unit√©s</span>
                                    </div>
                                    {% if form.nombre_machines_actives.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.nombre_machines_actives.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.nombre_machinistes.id_for_label }}" class="form-label required">
                                        Nombre de machinistes
                                    </label>
                                    <div class="input-group">
                                        {{ form.nombre_machinistes }}
                                        <span class="input-group-text">personnes</span>
                                    </div>
                                    {% if form.nombre_machinistes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.nombre_machinistes.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Production -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>Production
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.nombre_bobines_kg.id_for_label }}" class="form-label required">
                                        Bobines produites
                                    </label>
                                    <div class="input-group">
                                        {{ form.nombre_bobines_kg }}
                                        <span class="input-group-text">kg</span>
                                    </div>
                                    {% if form.nombre_bobines_kg.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.nombre_bobines_kg.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.production_finis_kg.id_for_label }}" class="form-label required">
                                        Produits finis
                                    </label>
                                    <div class="input-group">
                                        {{ form.production_finis_kg }}
                                        <span class="input-group-text">kg</span>
                                    </div>
                                    {% if form.production_finis_kg.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.production_finis_kg.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.production_semi_finis_kg.id_for_label }}" class="form-label required">
                                        Produits semi-finis
                                    </label>
                                    <div class="input-group">
                                        {{ form.production_semi_finis_kg }}
                                        <span class="input-group-text">kg</span>
                                    </div>
                                    {% if form.production_semi_finis_kg.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.production_semi_finis_kg.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.dechets_kg.id_for_label }}" class="form-label required">
                                        D√©chets g√©n√©r√©s
                                    </label>
                                    <div class="input-group">
                                        {{ form.dechets_kg }}
                                        <span class="input-group-text">kg</span>
                                    </div>
                                    {% if form.dechets_kg.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.dechets_kg.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observations -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-clipboard-list me-2"></i>Observations
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.observations.id_for_label }}" class="form-label">
                                Remarques et observations du jour
                            </label>
                            {{ form.observations }}
                            <div class="form-text">
                                <i class="fas fa-lightbulb me-1"></i>
                                D√©crivez les √©v√©nements marquants de la journ√©e de production
                            </div>
                        </div>
                    </div>
                </div>
            </div>


                <!-- Validation et actions -->
                <div class="card">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg" id="submit-btn">
                                <i class="fas fa-save me-2"></i>Enregistrer la production
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_css %}
<style>
.required::after {
    content: " *";
    color: #dc3545;
}

.calculations-grid .calc-item {
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
}

.calc-value {
    font-weight: 600;
    font-size: 1.1rem;
    transition: all 0.3s ease;
}

.card-header {
    font-weight: 600;
}

.form-control-lg {
    border-radius: 0.5rem;
}

.input-group-text {
    background-color: #f8f9fa;
    border: 1px solid #ced4da;
    font-weight: 500;
}

.badge {
    font-size: 0.75em;
}

/* Animation pour les calculs */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.calc-value.updated {
    animation: pulse 0.5s ease;
}

/* Styles pour les champs en erreur */
.form-control.is-invalid {
    border-color: #dc3545;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.invalid-feedback {
    display: block;
    color: #dc3545;
    font-size: 0.875em;
    margin-top: 0.25rem;
}

/* Animation pour les indicateurs */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.calc-item {
    animation: fadeIn 0.3s ease-out;
}

/* Styles pour les alertes */
.alert ul {
    padding-left: 1.5rem;
}

.alert ul li {
    margin-bottom: 0.25rem;
}

/* Responsive */
@media (max-width: 768px) {
    .container-fluid {
        padding-left: 15px;
        padding-right: 15px;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .btn-lg {
        width: 100%;
        margin-top: 0.5rem;
    }
    
    .d-flex.justify-content-between {
        flex-direction: column;
    }
    
    .row.g-3 > .col-md-4,
    .row.g-3 > .col-md-6 {
        margin-bottom: 1rem;
    }
    
    .calculations-grid {
        margin-bottom: 1rem;
    }
}

/* Highlight pour les champs modifi√©s */
.form-control.modified {
    border-color: #198754;
    background-color: rgba(25, 135, 84, 0.05);
}

/* Custom scrollbar */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Bouton submit avec √©tat */
#submit-btn:disabled {
    opacity: 0.65;
    cursor: not-allowed;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Fonction principale de calcul
function calculerAutomatique() {
    console.log('Calcul automatique d√©clench√©');
    
    // R√©cup√©ration des valeurs avec v√©rification
    const finis = parseFloat(document.getElementById('{{ form.production_finis_kg.id_for_label }}').value) || 0;
    const semiFinis = parseFloat(document.getElementById('{{ form.production_semi_finis_kg.id_for_label }}').value) || 0;
    const matiere = parseFloat(document.getElementById('{{ form.matiere_premiere_kg.id_for_label }}').value) || 0;
    const dechets = parseFloat(document.getElementById('{{ form.dechets_kg.id_for_label }}').value) || 0;
    const machines = parseInt(document.getElementById('{{ form.nombre_machines_actives.id_for_label }}').value) || 0;
    
    // Calcul de la dur√©e
    const heureDebut = document.getElementById('{{ form.heure_debut.id_for_label }}').value;
    const heureFin = document.getElementById('{{ form.heure_fin.id_for_label }}').value;
    let dureeHeures = 0;
    
    if (heureDebut && heureFin) {
        const debut = new Date('2000-01-01T' + heureDebut + ':00');
        const fin = new Date('2000-01-01T' + heureFin + ':00');
        
        // Gestion du passage √† minuit
        if (fin < debut) {
            fin.setHours(fin.getHours() + 24);
        }
        
        const diff = fin - debut;
        dureeHeures = diff / (1000 * 60 * 60);
        dureeHeures = dureeHeures > 0 ? dureeHeures : 0;
    }
    
    // Calculs
    const total = finis + semiFinis;
    const rendement = matiere > 0 ? (total / matiere) * 100 : 0;
    const tauxDechets = (total + dechets) > 0 ? (dechets / (total + dechets)) * 100 : 0;
    const prodMachine = machines > 0 ? total / machines : 0;
    const prodHoraire = dureeHeures > 0 ? total / dureeHeures : 0;
    
    // Formatage des valeurs
    const format = (value, decimals = 2) => value.toFixed(decimals);
    
    // Mise √† jour de l'affichage avec animation
    const updateValue = (elementId, value, suffix = '') => {
        const element = document.getElementById(elementId);
        if (element) {
            element.classList.remove('updated');
            void element.offsetWidth; // Trigger reflow
            element.textContent = format(value) + suffix;
            element.classList.add('updated');
        }
    };
    
    updateValue('calc-total', total, ' kg');
    updateValue('calc-rendement', rendement, '%');
    updateValue('calc-dechets', tauxDechets, '%');
    updateValue('calc-machine', prodMachine, ' kg');
    updateValue('calc-hourly', prodHoraire, ' kg/h');
    
    // Mise √† jour de la dur√©e affich√©e
    if (dureeHeures > 0) {
        const heures = Math.floor(dureeHeures);
        const minutes = Math.round((dureeHeures - heures) * 60);
        document.getElementById('calculated-duration').textContent = 
            `${heures}h${minutes.toString().padStart(2, '0')}`;
    }
    
    // V√©rification des alertes
    verifierAlertes(finis, semiFinis, matiere, dechets, rendement, tauxDechets);
}

// Fonction de validation et affichage des erreurs
function validerEtAfficher() {
    const validationResult = validerFormExtrusion();
    
    if (validationResult.valid) {
        // Afficher r√©sum√© dans une modal ou alert
        const resume = `
            ‚úÖ Validation r√©ussie !
            
            Production totale : ${validationResult.total.toFixed(2)} kg
            Rendement mati√®re : ${validationResult.rendement.toFixed(2)} %
            Taux de d√©chets : ${validationResult.tauxDechets.toFixed(2)} %
            Dur√©e de travail : ${validationResult.duree}
            
            Vous pouvez maintenant enregistrer.
        `;
        
        Swal.fire({
            title: 'Validation r√©ussie',
            text: 'Toutes les validations sont pass√©es avec succ√®s.',
            icon: 'success',
            confirmButtonText: 'Continuer',
            showCancelButton: true,
            cancelButtonText: 'Modifier'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('extrusion-form').submit();
            }
        });
    } else {
        // Afficher les erreurs
        let erreursHtml = '<ul>';
        validationResult.erreurs.forEach(erreur => {
            erreursHtml += `<li>${erreur}</li>`;
        });
        erreursHtml += '</ul>';
        
        Swal.fire({
            title: 'Erreurs de validation',
            html: erreursHtml,
            icon: 'error',
            confirmButtonText: 'Corriger'
        });
    }
}

// Fonction de validation compl√®te
function validerFormExtrusion() {
    const finis = parseFloat(document.getElementById('{{ form.production_finis_kg.id_for_label }}').value) || 0;
    const semiFinis = parseFloat(document.getElementById('{{ form.production_semi_finis_kg.id_for_label }}').value) || 0;
    const matiere = parseFloat(document.getElementById('{{ form.matiere_premiere_kg.id_for_label }}').value) || 0;
    const dechets = parseFloat(document.getElementById('{{ form.dechets_kg.id_for_label }}').value) || 0;
    const heureDebut = document.getElementById('{{ form.heure_debut.id_for_label }}').value;
    const heureFin = document.getElementById('{{ form.heure_fin.id_for_label }}').value;
    const machines = parseInt(document.getElementById('{{ form.nombre_machines_actives.id_for_label }}').value) || 0;
    const machinistes = parseInt(document.getElementById('{{ form.nombre_machinistes.id_for_label }}').value) || 0;
    
    let erreurs = [];
    let duree = '--:--';
    
    // 1. Validation rendement ‚â§ 100%
    if (matiere > 0) {
        const totalProduction = finis + semiFinis;
        if (totalProduction > matiere) {
            erreurs.push(`Production totale (${totalProduction.toFixed(2)} kg) > Mati√®re premi√®re (${matiere.toFixed(2)} kg)`);
        }
    }
    
    // 2. Validation d√©chets
    if (matiere > 0 && dechets > matiere) {
        erreurs.push(`D√©chets (${dechets.toFixed(2)} kg) > Mati√®re premi√®re (${matiere.toFixed(2)} kg)`);
    }
    
    // 3. Validation des heures
    if (heureDebut && heureFin) {
        const debut = new Date('2000-01-01T' + heureDebut + ':00');
        let fin = new Date('2000-01-01T' + heureFin + ':00');
        
        // Gestion travail de nuit
        if (fin < debut) {
            fin.setHours(fin.getHours() + 24);
        }
        
        const dureeHeures = (fin - debut) / (1000 * 60 * 60);
        
        if (dureeHeures <= 0) {
            erreurs.push('Heure de fin doit √™tre apr√®s heure de d√©but');
        } else {
            const heures = Math.floor(dureeHeures);
            const minutes = Math.round((dureeHeures - heures) * 60);
            duree = `${heures}h${minutes.toString().padStart(2, '0')}`;
            
            if (dureeHeures > 12) {
                erreurs.push(`Dur√©e de travail trop longue: ${duree} (max 12h)`);
            }
            
            if (dureeHeures < 1) {
                erreurs.push(`Dur√©e de travail trop courte: ${duree} (min 1h)`);
            }
        }
    }
    
    // 4. Validation machines vs machinistes (alerte seulement, pas d'erreur bloquante)
    if (machines > 0 && machinistes > 0) {
        if (machinistes < machines) {
            console.warn(`Attention: ${machinistes} machinistes pour ${machines} machines`);
            // C'est une alerte, pas une erreur bloquante
        }
        
        if (machinistes > machines * 3) {
            console.warn(`Beaucoup de machinistes: ${machinistes} pour ${machines} machines`);
            // C'est une alerte, pas une erreur bloquante
        }
    }
    
    // 5. Validation valeurs positives
    const checkNegative = (value, fieldName) => {
        if (value < 0) {
            erreurs.push(`${fieldName}: valeur n√©gative (${value})`);
        }
    };
    
    checkNegative(finis, 'Produits finis');
    checkNegative(semiFinis, 'Produits semi-finis');
    checkNegative(matiere, 'Mati√®re premi√®re');
    checkNegative(dechets, 'D√©chets');
    checkNegative(machines, 'Machines actives');
    checkNegative(machinistes, 'Nombre de machinistes');
    
    // Calcul des indicateurs pour le retour
    const total = finis + semiFinis;
    const rendement = matiere > 0 ? (total / matiere) * 100 : 0;
    const tauxDechets = (total + dechets) > 0 ? (dechets / (total + dechets)) * 100 : 0;
    
    return {
        valid: erreurs.length === 0,
        erreurs: erreurs,
        total: total,
        rendement: rendement,
        tauxDechets: tauxDechets,
        duree: duree
    };
}

// V√©rification des alertes en temps r√©el
function verifierAlertes(finis, semiFinis, matiere, dechets, rendement, tauxDechets) {
    // Ici vous pouvez impl√©menter des alertes visuelles
    // Par exemple, changer la couleur des indicateurs si hors normes
    const rendementElement = document.getElementById('calc-rendement');
    const dechetsElement = document.getElementById('calc-dechets');
    
    if (rendementElement) {
        if (rendement > 100) {
            rendementElement.classList.remove('bg-success');
            rendementElement.classList.add('bg-danger');
        } else if (rendement < 80) {
            rendementElement.classList.remove('bg-success');
            rendementElement.classList.add('bg-warning');
        } else {
            rendementElement.classList.remove('bg-danger', 'bg-warning');
            rendementElement.classList.add('bg-success');
        }
    }
    
    if (dechetsElement) {
        if (tauxDechets > 10) {
            dechetsElement.classList.remove('bg-danger');
            dechetsElement.classList.add('bg-danger', 'blink');
        } else {
            dechetsElement.classList.remove('bg-danger', 'blink');
            dechetsElement.classList.add('bg-danger');
        }
    }
}

// Gestion des √©v√©nements
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM charg√©, initialisation des √©v√©nements');
    
    const extrusionForm = document.getElementById('extrusion-form');
    if (extrusionForm) {
        // Ajoute la validation au formulaire extrusion
        extrusionForm.addEventListener('submit', function(e) {
            const validation = validerFormExtrusion();
            if (!validation.valid) {
                e.preventDefault();
                
                let erreursHtml = '<ul>';
                validation.erreurs.forEach(erreur => {
                    erreursHtml += `<li>${erreur}</li>`;
                });
                erreursHtml += '</ul>';
                
                // Utilisation de SweetAlert2 si disponible, sinon alert standard
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'Erreurs de validation',
                        html: erreursHtml,
                        icon: 'error',
                        confirmButtonText: 'Corriger'
                    });
                } else {
                    alert('ERREURS DE VALIDATION:\n\n' + validation.erreurs.join('\n‚Ä¢ '));
                }
            }
        });
        
        // Calcul automatique lors de la saisie
        const extrusionInputs = [
            '{{ form.production_finis_kg.id_for_label }}',
            '{{ form.production_semi_finis_kg.id_for_label }}',
            '{{ form.matiere_premiere_kg.id_for_label }}',
            '{{ form.dechets_kg.id_for_label }}',
            '{{ form.nombre_machines_actives.id_for_label }}',
            '{{ form.heure_debut.id_for_label }}',
            '{{ form.heure_fin.id_for_label }}',
            '{{ form.nombre_machinistes.id_for_label }}'
        ];
        
        extrusionInputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', function() {
                    calculerAutomatique();
                    this.classList.add('modified');
                });
            }
        });
        
        // Mise √† jour des informations de zone
        const zoneSelect = document.getElementById('{{ form.zone.id_for_label }}');
        if (zoneSelect) {
            zoneSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const capacity = selectedOption.getAttribute('data-capacity') || '--';
                
                const zoneCapacityElement = document.getElementById('zone-capacity');
                if (zoneCapacityElement) {
                    zoneCapacityElement.textContent = capacity;
                }
                
                calculerAutomatique();
            });
        }
        
        // Initialisation - premier calcul
        setTimeout(calculerAutomatique, 100);
    }
    
    // MARQUAGE DES CHAMPS REQUIS
    const requiredInputs = document.querySelectorAll('[required]');
    requiredInputs.forEach(input => {
        const label = input.closest('.mb-3')?.querySelector('.form-label');
        if (label && !label.innerHTML.includes('*')) {
            label.classList.add('required');
        }
    });
    
    // Gestion des champs num√©riques - emp√™cher les valeurs n√©gatives
    const numberInputs = document.querySelectorAll('input[type="number"]');
    numberInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.value < 0) {
                this.value = 0;
                calculerAutomatique();
            }
        });
    });
});

// Fonction de calcul de dur√©e
function calculateDuration(start, end) {
    if (!start || !end) return '--:--';
    
    const startDate = new Date('2000-01-01T' + start + ':00');
    const endDate = new Date('2000-01-01T' + end + ':00');
    
    if (endDate < startDate) {
        endDate.setHours(endDate.getHours() + 24);
    }
    
    const diff = endDate - startDate;
    const hours = Math.floor(diff / 3600000);
    const minutes = Math.floor((diff % 3600000) / 60000);
    
    return {
        heures: hours,
        minutes: minutes,
        totalHeures: diff / 3600000,
        format: `${hours}h${minutes.toString().padStart(2, '0')}`
    };
}
</script>
{% endblock %}