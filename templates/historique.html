{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% load math_filters %}

{% block title %}Historique de Production - SOFEM-CI{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- En-t√™te avec statistiques -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h2 mb-2">üìä Historique de Production</h1>
                    <p class="text-muted mb-0">Analyse compl√®te des donn√©es de production historiques</p>
                </div>
                <div class="d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-2"></i>Exporter
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="exporterExcel()"><i class="fas fa-file-excel me-2"></i>Excel (.xlsx)</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exporterPDF()"><i class="fas fa-file-pdf me-2"></i>PDF Rapport</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exporterCSV()"><i class="fas fa-file-csv me-2"></i>CSV Donn√©es</a></li>
                        </ul>
                    </div>
                    <button class="btn btn-outline-primary" onclick="toggleVueResume()">
                        <i class="fas fa-chart-bar me-2"></i>Vue Graphique
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cartes de r√©sum√© -->
    <div class="row mb-4" id="resume-cards">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-stats border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                                <i class="fas fa-industry"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h4 class="card-title text-primary mb-1">
                                {% with total_general=totaux.extrusion.total|add:totaux.soudure.total|add:totaux.imprimerie.total|add:totaux.recyclage.total %}
                                    {{ total_general|floatformat:0|intcomma }} kg
                                {% endwith %}
                            </h4>
                            <p class="card-text text-muted mb-0">Production Totale</p>
                            <small class="text-success">
                                <i class="fas fa-calendar me-1"></i>
                                {{ periode_debut|date:"d/m/Y" }} - {{ periode_fin|date:"d/m/Y" }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-stats border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="stat-icon bg-success bg-opacity-10 text-success">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h4 class="card-title text-success mb-1">
                                {% with total_general=totaux.extrusion.total|add:totaux.soudure.total|add:totaux.imprimerie.total|add:totaux.recyclage.total %}
                                    {% if productions.paginator.count > 0 %}
                                        {{ total_general|div:productions.paginator.count|floatformat:0|intcomma }}
                                    {% else %}
                                        0
                                    {% endif %} kg/j
                                {% endwith %}
                            </h4>
                            <p class="card-text text-muted mb-0">Moyenne Journali√®re</p>
                            <small class="text-success">
                                <i class="fas fa-check me-1"></i>{{ productions.paginator.count }} jours
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-stats border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                                <i class="fas fa-cogs"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h4 class="card-title text-warning mb-1">{{ productions.paginator.count|default:0 }}</h4>
                            <p class="card-text text-muted mb-0">Jours de Production</p>
                            <small class="text-muted">
                                P√©riode analys√©e
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-stats border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="stat-icon bg-info bg-opacity-10 text-info">
                                <i class="fas fa-tachometer-alt"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            {% with total_dechets=totaux.extrusion.dechets|add:totaux.soudure.dechets|add:totaux.imprimerie.dechets|add:totaux.recyclage.dechets %}
                            {% with total_production=totaux.extrusion.total|add:totaux.soudure.total|add:totaux.imprimerie.total|add:totaux.recyclage.total %}
                                {% if total_production > 0 %}
                                    {% with taux_dechets=total_dechets|percentage:total_production %}
                                        <h4 class="card-title text-info mb-1">{{ taux_dechets|floatformat:1 }}%</h4>
                                        <p class="card-text text-muted mb-0">Taux de D√©chets</p>
                                        <small class="{% if taux_dechets > 5 %}text-danger{% else %}text-success{% endif %}">
                                            <i class="fas fa-{% if taux_dechets > 5 %}exclamation-triangle{% else %}check{% endif %} me-1"></i>
                                            {{ total_dechets|floatformat:0|intcomma }} kg de d√©chets
                                        </small>
                                    {% endwith %}
                                {% else %}
                                    <h4 class="card-title text-info mb-1">0.0%</h4>
                                    <p class="card-text text-muted mb-0">Taux de D√©chets</p>
                                    <small class="text-muted">Aucune production</small>
                                {% endif %}
                            {% endwith %}
                            {% endwith %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres avanc√©s -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-filter me-2 text-primary"></i>Filtres Avanc√©s
                </h5>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse">
                    <i class="fas fa-chevron-down me-1"></i>
                    <span class="collapse-text">Masquer</span>
                </button>
            </div>
        </div>
        <div class="collapse show" id="filtersCollapse">
            <div class="card-body">
                <form method="get" id="filter-form">
                    <div class="row g-3">
                        <!-- P√©riode -->
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-calendar me-1 text-muted"></i>P√©riode
                            </label>
                            <select name="periode" class="form-select" id="periode-select">
                                <option value="ce_mois" {% if request.GET.periode == 'ce_mois' %}selected{% endif %}>Ce Mois</option>
                                <option value="mois_dernier" {% if request.GET.periode == 'mois_dernier' %}selected{% endif %}>Mois Dernier</option>
                                <option value="trimestre" {% if request.GET.periode == 'trimestre' %}selected{% endif %}>Ce Trimestre</option>
                                <option value="personnalise" {% if request.GET.periode == 'personnalise' %}selected{% endif %}>Personnalis√©</option>
                            </select>
                        </div>

                        <!-- Dates personnalis√©es -->
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Date D√©but</label>
                            <input type="date" name="date_debut" class="form-control" id="date-debut"
                                   value="{{ request.GET.date_debut|default:periode_debut|date:'Y-m-d' }}">
                        </div>

                        <div class="col-md-2">
                            <label class="form-label fw-semibold">Date Fin</label>
                            <input type="date" name="date_fin" class="form-control" id="date-fin"
                                   value="{{ request.GET.date_fin|default:periode_fin|date:'Y-m-d' }}">
                        </div>

                        <!-- Section -->
                        <div class="col-md-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-industry me-1 text-muted"></i>Section
                            </label>
                            <select name="section" class="form-select" id="section-select">
                                <option value="">Toutes les Sections</option>
                                <option value="extrusion" {% if request.GET.section == 'extrusion' %}selected{% endif %}>
                                    üîß Extrusion
                                </option>
                                <option value="soudure" {% if request.GET.section == 'soudure' %}selected{% endif %}>
                                    ‚ö° Soudure
                                </option>
                                <option value="imprimerie" {% if request.GET.section == 'imprimerie' %}selected{% endif %}>
                                    üñ®Ô∏è Imprimerie
                                </option>
                                <option value="recyclage" {% if request.GET.section == 'recyclage' %}selected{% endif %}>
                                    ‚ôªÔ∏è Recyclage
                                </option>
                            </select>
                        </div>

                        <!-- √âquipe -->
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-users me-1 text-muted"></i>√âquipe
                            </label>
                            <select name="equipe" class="form-select" id="equipe-select">
                                <option value="">Toutes les √âquipes</option>
                                {% for equipe in equipes %}
                                <option value="{{ equipe.id }}" {% if request.GET.equipe == equipe.id|stringformat:"i" %}selected{% endif %}>
                                    {{ equipe.get_nom_display }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Boutons d'action -->
                    <div class="row mt-4">
                        <div class="col-12 d-flex gap-2 justify-content-between">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-2"></i>Appliquer les Filtres
                                </button>
                                <a href="{% url 'historique' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-redo me-2"></i>R√©initialiser
                                </a>
                            </div>
                            <div class="d-flex gap-2 align-items-center">
                                <span class="text-muted small">Tri:</span>
                                <select name="tri" class="form-select form-select-sm w-auto" id="tri-select">
                                    <option value="-date" {% if request.GET.tri == '-date' %}selected{% endif %}>Date ‚Üì</option>
                                    <option value="date" {% if request.GET.tri == 'date' %}selected{% endif %}>Date ‚Üë</option>
                                    <option value="-total" {% if request.GET.tri == '-total' %}selected{% endif %}>Production ‚Üì</option>
                                    <option value="total" {% if request.GET.tri == 'total' %}selected{% endif %}>Production ‚Üë</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Tableau principal -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0 me-3 d-inline-block">
                        <i class="fas fa-table me-2 text-primary"></i>D√©tails de Production
                    </h5>
                    {% if request.GET.section %}
                    <span class="badge bg-primary">{{ request.GET.section|title }}</span>
                    {% endif %}
                    {% if request.GET.periode %}
                    <span class="badge bg-secondary ms-1">{{ request.GET.periode|title }}</span>
                    {% endif %}
                    <span class="badge bg-light text-dark ms-1">
                        {{ periode_debut|date:"d/m/Y" }} - {{ periode_fin|date:"d/m/Y" }}
                    </span>
                </div>
                <div class="text-muted small">
                    <i class="fas fa-list me-1"></i>
                    {{ productions.paginator.count|default:0 }} enregistrement(s)
                </div>
            </div>
        </div>

        {% if productions %}
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 production-table">
                <thead class="table-light">
                    <tr>
                        <th width="120" class="ps-4">
                            <i class="fas fa-calendar me-1 text-muted"></i>Date
                        </th>
                        <th width="140" class="text-center">
                            <i class="fas fa-cogs me-1 text-primary"></i>Extrusion
                            <br><small class="text-muted fw-normal">{{ totaux.extrusion.total|floatformat:0|intcomma }} kg</small>
                        </th>
                        <th width="140" class="text-center">
                            <i class="fas fa-bolt me-1 text-warning"></i>Soudure
                            <br><small class="text-muted fw-normal">{{ totaux.soudure.total|floatformat:0|intcomma }} kg</small>
                        </th>
                        <th width="140" class="text-center">
                            <i class="fas fa-print me-1 text-info"></i>Imprimerie
                            <br><small class="text-muted fw-normal">{{ totaux.imprimerie.total|floatformat:0|intcomma }} kg</small>
                        </th>
                        <th width="140" class="text-center">
                            <i class="fas fa-recycle me-1 text-success"></i>Recyclage
                            <br><small class="text-muted fw-normal">{{ totaux.recyclage.total|floatformat:0|intcomma }} kg</small>
                        </th>
                        <th width="140" class="text-center bg-light">
                            <i class="fas fa-chart-bar me-1 text-danger"></i>Total Jour
                        </th>
                        <th width="100" class="text-center">
                            <i class="fas fa-cog me-1 text-muted"></i>Actions
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for production in productions %}
                    <tr class="production-row border-bottom" data-date="{{ production.date_production|date:'Y-m-d' }}">
                        <!-- Date -->
                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <div class="date-indicator bg-primary bg-opacity-10 text-primary rounded p-2 me-3">
                                    <div class="text-center">
                                        <div class="fw-bold fs-6">{{ production.date_production|date:"d" }}</div>
                                        <div class="small text-muted">{{ production.date_production|date:"M" }}</div>
                                    </div>
                                </div>
                                <div class="small">
                                    <div class="fw-semibold">{{ production.date_production|date:"l" }}</div>
                                    <div class="text-muted">{{ production.date_production|date:"Y" }}</div>
                                </div>
                            </div>
                        </td>

                        <!-- Extrusion -->
                        <td class="text-center">
                            {% if production.extrusion > 0 %}
                            <div class="production-cell extrusion-cell" data-bs-toggle="tooltip" 
                                 title="D√©chets: {{ totaux.extrusion.dechets|floatformat:0|intcomma }} kg">
                                <div class="fw-bold text-primary fs-6">{{ production.extrusion|floatformat:0|intcomma }}</div>
                                <small class="text-muted">kg</small>
                            </div>
                            {% else %}
                            <span class="text-muted fst-italic">‚Äî</span>
                            {% endif %}
                        </td>

                        <!-- Soudure -->
                        <td class="text-center">
                            {% if production.soudure > 0 %}
                            <div class="production-cell soudure-cell" data-bs-toggle="tooltip"
                                 title="D√©chets: {{ totaux.soudure.dechets|floatformat:0|intcomma }} kg">
                                <div class="fw-bold text-warning fs-6">{{ production.soudure|floatformat:0|intcomma }}</div>
                                <small class="text-muted">kg</small>
                            </div>
                            {% else %}
                            <span class="text-muted fst-italic">‚Äî</span>
                            {% endif %}
                        </td>

                        <!-- Imprimerie -->
                        <td class="text-center">
                            {% if production.imprimerie > 0 %}
                            <div class="production-cell imprimerie-cell" data-bs-toggle="tooltip"
                                 title="D√©chets: {{ totaux.imprimerie.dechets|floatformat:0|intcomma }} kg">
                                <div class="fw-bold text-info fs-6">{{ production.imprimerie|floatformat:0|intcomma }}</div>
                                <small class="text-muted">kg</small>
                            </div>
                            {% else %}
                            <span class="text-muted fst-italic">‚Äî</span>
                            {% endif %}
                        </td>

                        <!-- Recyclage -->
                        <td class="text-center">
                            {% if production.recyclage > 0 %}
                            <div class="production-cell recyclage-cell">
                                <div class="fw-bold text-success fs-6">{{ production.recyclage|floatformat:0|intcomma }}</div>
                                <small class="text-muted">kg</small>
                            </div>
                            {% else %}
                            <span class="text-muted fst-italic">‚Äî</span>
                            {% endif %}
                        </td>

                        <!-- Total Jour -->
                        <td class="text-center bg-light bg-opacity-50">
                            <div class="total-cell">
                                <div class="fw-bold text-danger fs-6">{{ production.total_jour|floatformat:0|intcomma }}</div>
                                <small class="text-muted">kg</small>
                                {% with total_sections=production.extrusion|add:production.soudure|add:production.imprimerie|add:production.recyclage %}
                                {% if total_sections > 0 %}
                                <div class="progress mt-1" style="height: 4px;">
                                    {% with extrusion_pct=production.extrusion|percentage:total_sections %}
                                    {% with soudure_pct=production.soudure|percentage:total_sections %}
                                    {% with imprimerie_pct=production.imprimerie|percentage:total_sections %}
                                    {% with recyclage_pct=production.recyclage|percentage:total_sections %}
                                        <div class="progress-bar bg-primary" style="width: {{ extrusion_pct }}%"></div>
                                        <div class="progress-bar bg-warning" style="width: {{ soudure_pct }}%"></div>
                                        <div class="progress-bar bg-info" style="width: {{ imprimerie_pct }}%"></div>
                                        <div class="progress-bar bg-success" style="width: {{ recyclage_pct }}%"></div>
                                    {% endwith %}
                                    {% endwith %}
                                    {% endwith %}
                                    {% endwith %}
                                </div>
                                {% endif %}
                                {% endwith %}
                            </div>
                        </td>

                        <!-- Actions -->
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary btn-action" 
                                        onclick="voirDetails('{{ production.date_production|date:"Y-m-d" }}')"
                                        data-bs-toggle="tooltip" title="Voir d√©tails du jour">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-success btn-action"
                                        onclick="telechargerFiche('{{ production.date_production|date:"Y-m-d" }}')"
                                        data-bs-toggle="tooltip" title="T√©l√©charger fiche">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                
                <!-- Ligne de totaux -->
                <tfoot class="table-dark">
                    <tr>
                        <td class="ps-4 fw-bold">TOTAUX</td>
                        <td class="text-center fw-bold text-primary">{{ totaux.extrusion.total|floatformat:0|intcomma }} kg</td>
                        <td class="text-center fw-bold text-warning">{{ totaux.soudure.total|floatformat:0|intcomma }} kg</td>
                        <td class="text-center fw-bold text-info">{{ totaux.imprimerie.total|floatformat:0|intcomma }} kg</td>
                        <td class="text-center fw-bold text-success">{{ totaux.recyclage.total|floatformat:0|intcomma }} kg</td>
                        <td class="text-center fw-bold text-white bg-danger">
                            {% with total_general=totaux.extrusion.total|add:totaux.soudure.total|add:totaux.imprimerie.total|add:totaux.recyclage.total %}
                                {{ total_general|floatformat:0|intcomma }} kg
                            {% endwith %}
                        </td>
                        <td class="text-center">
                            <span class="badge bg-light text-dark">
                                Moyenne: 
                                {% with total_general=totaux.extrusion.total|add:totaux.soudure.total|add:totaux.imprimerie.total|add:totaux.recyclage.total %}
                                    {% if productions.paginator.count > 0 %}
                                        {{ total_general|div:productions.paginator.count|floatformat:0|intcomma }}
                                    {% else %}
                                        0
                                    {% endif %} kg/j
                                {% endwith %}
                            </span>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Pagination -->
        {% if productions.has_other_pages %}
        <div class="card-footer bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                    Affichage de {{ productions.start_index }} √† {{ productions.end_index }} sur {{ productions.paginator.count }} entr√©es
                </div>
                <nav aria-label="Navigation des pages">
                    <ul class="pagination pagination-sm mb-0">
                        {% if productions.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    <i class="fas fa-angle-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ productions.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    <i class="fas fa-angle-left"></i>
                                </a>
                            </li>
                        {% endif %}

                        {% for num in productions.paginator.page_range %}
                            {% if productions.number == num %}
                                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                            {% elif num > productions.number|add:'-3' and num < productions.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if productions.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ productions.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    <i class="fas fa-angle-right"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ productions.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    <i class="fas fa-angle-double-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}

        {% else %}
        <div class="card-body text-center py-5">
            <div class="empty-state">
                <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                <h4 class="text-muted mb-3">Aucune donn√©e de production</h4>
                <p class="text-muted mb-4">Aucune production ne correspond aux crit√®res de recherche s√©lectionn√©s.</p>
                <div class="d-flex gap-2 justify-content-center">
                    <a href="{% url 'saisie_production' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Saisir une Production
                    </a>
                    <a href="{% url 'historique' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-redo me-2"></i>Afficher Toutes les Donn√©es
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal D√©tails -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>D√©tails de la Production
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Contenu charg√© dynamiquement -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card-stats {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-left: 4px solid transparent;
}

.card-stats:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
}

.date-indicator {
    min-width: 50px;
    transition: all 0.3s ease;
}

.production-row:hover .date-indicator {
    background: var(--bs-primary) !important;
    color: white !important;
    transform: scale(1.05);
}

.production-cell {
    padding: 8px 4px;
    border-radius: 6px;
    transition: all 0.3s ease;
    cursor: help;
}

.production-cell:hover {
    background: rgba(0,0,0,0.03);
    transform: scale(1.02);
}

.extrusion-cell { border-left: 3px solid var(--bs-primary); }
.soudure-cell { border-left: 3px solid var(--bs-warning); }
.imprimerie-cell { border-left: 3px solid var(--bs-info); }
.recyclage-cell { border-left: 3px solid var(--bs-success); }

.production-row {
    transition: all 0.3s ease;
}

.production-row:hover {
    background: linear-gradient(90deg, rgba(52, 152, 219, 0.05) 0%, rgba(52, 152, 219, 0.02) 100%);
}

.btn-action {
    border-radius: 6px;
    padding: 4px 8px;
    transition: all 0.3s ease;
}

.btn-action:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.progress {
    background-color: #e9ecef;
    border-radius: 2px;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.production-row {
    animation: fadeInUp 0.5s ease-out;
}

@media (max-width: 768px) {
    .card-stats .card-body {
        padding: 1rem;
    }
    
    .stat-icon {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
    }
    
    .production-cell .fs-6 {
        font-size: 0.9rem !important;
    }
    
    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function voirDetails(dateProduction) {
    const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
    
    document.getElementById('modal-body').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2 text-muted">Chargement des d√©tails pour le ${dateProduction}...</p>
        </div>
    `;
    
    modal.show();
    
    setTimeout(() => {
        document.getElementById('modal-body').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-muted mb-3">
                                <i class="fas fa-info-circle me-2"></i>Production du ${dateProduction}
                            </h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <small class="text-muted">Date</small>
                                    <div class="fw-bold">${new Date(dateProduction).toLocaleDateString('fr-FR')}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Jour</small>
                                    <div class="fw-bold">${new Date(dateProduction).toLocaleDateString('fr-FR', { weekday: 'long' })}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 bg-light">
                        <div class="card-body">
                            <h6 class="card-title text-muted mb-3">
                                <i class="fas fa-chart-pie me-2"></i>R√©partition
                            </h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <small class="text-muted">Extrusion</small>
                                    <div class="fw-bold text-primary">${(Math.random() * 1000 + 500).toFixed(0)} kg</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Soudure</small>
                                    <div class="fw-bold text-warning">${(Math.random() * 200 + 50).toFixed(0)} kg</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-12">
                    <h6 class="text-muted mb-3">
                        <i class="fas fa-clipboard-list me-2"></i>Observations
                    </h6>
                    <div class="alert alert-info">
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            Production normale pour cette journ√©e. Aucun incident signal√©.
                            Taux de rendement global: ${(Math.random() * 5 + 95).toFixed(1)}%
                        </small>
                    </div>
                </div>
            </div>
        `;
    }, 1000);
}

function exporterExcel() {
    showNotification('Pr√©paration du fichier Excel...', 'info');
}

function exporterPDF() {
    showNotification('G√©n√©ration du rapport PDF...', 'info');
}

function exporterCSV() {
    showNotification('Export des donn√©es CSV...', 'info');
}

function telechargerFiche(dateProduction) {
    showNotification(`T√©l√©chargement de la fiche du ${dateProduction}`, 'success');
}

function toggleVueResume() {
    const resumeCards = document.getElementById('resume-cards');
    resumeCards.style.display = resumeCards.style.display === 'none' ? 'flex' : 'none';
    showNotification('Vue r√©sum√© ' + (resumeCards.style.display === 'none' ? 'masqu√©e' : 'affich√©e'), 'info');
}

function showNotification(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.appendChild(toast);
    document.body.appendChild(container);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => {
        container.remove();
    });
}

document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    const filtersCollapse = document.getElementById('filtersCollapse');
    const collapseText = document.querySelector('.collapse-text');
    
    if (filtersCollapse) {
        filtersCollapse.addEventListener('show.bs.collapse', function () {
            collapseText.textContent = 'Masquer';
        });
        
        filtersCollapse.addEventListener('hide.bs.collapse', function () {
            collapseText.textContent = 'Afficher';
        });
    }
    
    const autoSubmitSelects = ['periode-select', 'section-select', 'tri-select'];
    autoSubmitSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.addEventListener('change', function() {
                document.getElementById('filter-form').submit();
            });
        }
    });
    
    const periodeSelect = document.getElementById('periode-select');
    if (periodeSelect) {
        periodeSelect.addEventListener('change', function() {
            if (this.value !== 'personnalise') {
                document.getElementById('date-debut').value = '';
                document.getElementById('date-fin').value = '';
            }
        });
    }
});
</script>
{% endblock %}