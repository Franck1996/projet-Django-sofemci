{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Rapports - SOFEM-CI{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-2">üìà Rapports et Analyses</h1>
            <p class="text-muted mb-0">G√©n√©ration et consultation des rapports de production</p>
        </div>
    </div>

    <!-- S√©lection de p√©riode -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>Param√®tres du Rapport
            </h5>
        </div>
        <div class="card-body">
            <form method="get" class="period-form">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Mois</label>
                        <select name="mois" class="form-select" required>
                            <option value="">S√©lectionnez un mois</option>
                            {% for mois in mois_disponibles %}
                            <option value="{{ mois.value }}" {% if mois.value == request.GET.mois %}selected{% endif %}>
                                {{ mois.nom }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Ann√©e</label>
                        <select name="annee" class="form-select" required>
                            <option value="">S√©lectionnez une ann√©e</option>
                            {% for annee in annees_disponibles %}
                            <option value="{{ annee }}" {% if annee == annee_courante %}selected{% endif %}>
                                {{ annee }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">Section</label>
                        <select name="section" class="form-select">
                            <option value="">Toutes les sections</option>
                            <option value="extrusion" {% if section_selectionnee == 'extrusion' %}selected{% endif %}>Extrusion</option>
                            <option value="imprimerie" {% if section_selectionnee == 'imprimerie' %}selected{% endif %}>Imprimerie</option>
                            <option value="soudure" {% if section_selectionnee == 'soudure' %}selected{% endif %}>Soudure</option>
                            <option value="recyclage" {% if section_selectionnee == 'recyclage' %}selected{% endif %}>Recyclage</option>
                        </select>
                    </div>
                </div>

                <!-- Nouvelle section des boutons -->
                <div class="form-actions mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-chart-bar me-2"></i>G√©n√©rer le rapport
                    </button>
                    
                    {% if rapport %}
                    <a href="?mois={{ request.GET.mois }}&annee={{ request.GET.annee }}&section={{ request.GET.section }}&export=excel" 
                       class="btn btn-success">
                        <i class="fas fa-file-excel me-2"></i>Exporter Excel
                    </a>
                    <a href="?mois={{ request.GET.mois }}&annee={{ request.GET.annee }}&section={{ request.GET.section }}&export=pdf" 
                       class="btn btn-danger">
                        <i class="fas fa-file-pdf me-2"></i>G√©n√©rer PDF
                    </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- R√©sum√© du rapport -->
    {% if rapport %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-chart-pie me-2"></i>Rapport - {{ mois_nom }} {{ annee_courante }}
            </h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card card-stats border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                                        <i class="fas fa-industry"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h4 class="card-title text-primary mb-1">{{ rapport.total_production|floatformat:0|intcomma }} kg</h4>
                                    <p class="card-text text-muted mb-0">Production Totale</p>
                                    <small class="{% if rapport.evolution_production >= 0 %}text-success{% else %}text-danger{% endif %}">
                                        <i class="fas fa-arrow-{% if rapport.evolution_production >= 0 %}up{% else %}down{% endif %} me-1"></i>
                                        {{ rapport.evolution_production|floatformat:1 }}%
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card card-stats border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="stat-icon bg-success bg-opacity-10 text-success">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h4 class="card-title text-success mb-1">{{ rapport.rendement_moyen|floatformat:1 }}%</h4>
                                    <p class="card-text text-muted mb-0">Rendement Moyen</p>
                                    <small class="{% if rapport.evolution_rendement >= 0 %}text-success{% else %}text-danger{% endif %}">
                                        <i class="fas fa-arrow-{% if rapport.evolution_rendement >= 0 %}up{% else %}down{% endif %} me-1"></i>
                                        {{ rapport.evolution_rendement|floatformat:1 }}%
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card card-stats border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                                        <i class="fas fa-trash"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h4 class="card-title text-warning mb-1">{{ rapport.taux_dechet_moyen|floatformat:1 }}%</h4>
                                    <p class="card-text text-muted mb-0">Taux D√©chet Moyen</p>
                                    <small class="{% if rapport.evolution_dechets < 0 %}text-success{% else %}text-danger{% endif %}">
                                        <i class="fas fa-arrow-{% if rapport.evolution_dechets < 0 %}down{% else %}up{% endif %} me-1"></i>
                                        {{ rapport.evolution_dechets|floatformat:1 }}%
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card card-stats border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="stat-icon bg-info bg-opacity-10 text-info">
                                        <i class="fas fa-calendar"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h4 class="card-title text-info mb-1">{{ rapport.jours_production }}</h4>
                                    <p class="card-text text-muted mb-0">Jours de Production</p>
                                    <small class="text-muted">
                                        <i class="fas fa-chart-bar me-1"></i>{{ rapport.taux_activite }}%
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Le reste de votre template existant reste inchang√© -->
    <!-- ... -->

    {% else %}
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-chart-bar fa-4x text-muted mb-3"></i>
            <h4 class="text-muted mb-3">Aucun rapport g√©n√©r√©</h4>
            <p class="text-muted mb-4">S√©lectionnez une p√©riode et cliquez sur "G√©n√©rer le rapport" pour afficher les donn√©es.</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
