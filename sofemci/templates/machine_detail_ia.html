{% extends 'base.html' %}
{% load static %}

{% block title %}Détail Machine {{ machine.numero }} - IA{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div>
            <h1>Machine {{ machine.numero }}</h1>
            <p>{{ machine.get_section_display }} - {{ machine.get_type_machine_display }}</p>
        </div>
        <a href="{% url 'dashboard_ia' %}" class="btn-secondary">Retour Dashboard IA</a>
    </div>

    <!-- Scores et métriques -->
    <div class="metrics-ia-grid">
        <div class="metric-card {% if analyse.score_sante >= 80 %}good{% elif analyse.score_sante >= 60 %}warning{% else %}critical{% endif %}">
            <h3>Score Santé</h3>
            <div class="metric-value">{{ analyse.score_sante }}%</div>
        </div>

        <div class="metric-card {% if analyse.probabilite_panne_7j < 20 %}good{% elif analyse.probabilite_panne_7j < 40 %}warning{% else %}critical{% endif %}">
            <h3>Risque Panne 7j</h3>
            <div class="metric-value">{{ analyse.probabilite_panne_7j }}%</div>
        </div>

        <div class="metric-card">
            <h3>Risque Panne 30j</h3>
            <div class="metric-value">{{ analyse.probabilite_panne_30j }}%</div>
        </div>

        <div class="metric-card">
            <h3>Niveau Risque</h3>
            <div class="metric-value risk-{{ analyse.niveau_risque }}">{{ analyse.niveau_risque|upper }}</div>
        </div>
    </div>

    <!-- Facteurs de risque -->
    {% if analyse.facteurs_risque %}
    <div class="section-box warning">
        <h2>Facteurs de Risque Identifiés</h2>
        <ul class="risk-list">
            {% for facteur in analyse.facteurs_risque %}
            <li>{{ facteur }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Anomalies -->
    {% if analyse.anomalies %}
    <div class="section-box danger">
        <h2>Anomalies Détectées</h2>
        <ul class="anomaly-list">
            {% for anomalie in analyse.anomalies %}
            <li>{{ anomalie }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Actions rapides -->
    <div class="quick-actions">
        <a href="{% url 'enregistrer_maintenance' machine.id %}" class="btn-action maintenance">
            Enregistrer Maintenance
        </a>
        <a href="{% url 'enregistrer_panne' machine.id %}" class="btn-action panne">
            Enregistrer Panne
        </a>
        {% if user.role == 'admin' %}
        <a href="{% url 'simuler_capteurs' machine.id %}" class="btn-action simulate">
            Simuler Capteurs
        </a>
        {% endif %}
    </div>

    <!-- Graphiques -->
    <div class="charts-section">
        <div class="chart-box">
            <h3>Évolution Température (30 jours)</h3>
            <canvas id="tempChart"></canvas>
        </div>
        <div class="chart-box">
            <h3>Évolution Consommation (30 jours)</h3>
            <canvas id="consoChart"></canvas>
        </div>
    </div>

    <!-- Historique -->
    <div class="history-section">
        <h2>Historique des Événements</h2>
        <table class="history-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Technicien</th>
                </tr>
            </thead>
            <tbody>
                {% for event in historique %}
                <tr>
                    <td>{{ event.date_evenement|date:"d/m/Y H:i" }}</td>
                    <td><span class="badge-{{ event.type_evenement }}">{{ event.get_type_evenement_display }}</span></td>
                    <td>{{ event.description }}</td>
                    <td>{{ event.technicien|default:"--" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Alertes actives -->
    {% if alertes %}
    <div class="alerts-section">
        <h2>Alertes Actives</h2>
        {% for alerte in alertes %}
        <div class="alert-box alert-{{ alerte.niveau }}">
            <strong>{{ alerte.titre }}</strong>
            <p>{{ alerte.message }}</p>
            <small>{{ alerte.date_creation|date:"d/m/Y H:i" }}</small>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<style>
.metrics-ia-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 30px 0;
}

.metric-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    border-left: 4px solid #3498db;
}

.metric-card.good { border-left-color: #27ae60; }
.metric-card.warning { border-left-color: #f39c12; }
.metric-card.critical { border-left-color: #e74c3c; }

.metric-value {
    font-size: 2.5rem;
    font-weight: 700;
    margin-top: 10px;
}

.section-box {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin: 20px 0;
    border-left: 4px solid;
}

.section-box.warning { border-left-color: #f39c12; }
.section-box.danger { border-left-color: #e74c3c; }

.quick-actions {
    display: flex;
    gap: 15px;
    margin: 30px 0;
}

.btn-action {
    flex: 1;
    padding: 15px;
    text-align: center;
    border-radius: 8px;
    text-decoration: none;
    color: white;
    font-weight: 600;
}

.btn-action.maintenance { background: #27ae60; }
.btn-action.panne { background: #e74c3c; }
.btn-action.simulate { background: #9b59b6; }

.charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin: 30px 0;
}

.chart-box {
    background: white;
    padding: 20px;
    border-radius: 12px;
}

.history-table {
    width: 100%;
    background: white;
    border-radius: 12px;
    overflow: hidden;
}

.history-table th {
    background: #3498db;
    color: white;
    padding: 12px;
}

.history-table td {
    padding: 12px;
    border-bottom: 1px solid #ecf0f1;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const chartData = {{ donnees_graphique|safe }};

new Chart(document.getElementById('tempChart'), {
    type: 'line',
    data: {
        labels: chartData.dates,
        datasets: [{
            label: 'Température (°C)',
            data: chartData.temperatures,
            borderColor: '#e74c3c',
            tension: 0.4
        }]
    }
});

new Chart(document.getElementById('consoChart'), {
    type: 'line',
    data: {
        labels: chartData.dates,
        datasets: [{
            label: 'Consommation (kWh)',
            data: chartData.consommations,
            borderColor: '#3498db',
            tension: 0.4
        }]
    }
});
</script>
{% endblock %}